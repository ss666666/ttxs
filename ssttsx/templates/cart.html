{% extends 'base_user.html' %}

{% block head %}

    <script>
        $(function () {
            //初始化计算
            get_total();

            //找到所有的checkbox， 排除id为checkall的项
            $(':checkbox:not(#checkall)').click(function () {
                //获取小计
                var total = parseFloat($(this).parent().siblings('.col07').children('em').text());
                //获取数量
                var count = parseInt($(this).parent().siblings('.col06').find('.num_show').val());
                //获取总计
                var total_price = parseFloat($('.settlements em').text());
                var total_select = parseInt($('.settlements b').text());

                //总量
                //判断是否选中，是就加，否就减
                if ($(this).prop('checked')){
                    //加
                    total_price += total;
                    total_select += count;
                } else {
                    //减
                    total_price -= total;
                    total_select -= count;
                }

                //显示总计，总数量
                $('.settlements em').text(total_price.toFixed(2));
                $('.settlements b').text(total_select);

                //设置checkall是否被选中
                //获取所有的checkbox，排除checkall
                var checkbox_len = $(':checkbox:not(#checkall)').length;
                //获取所有选中的checkbox，排除checkall
                var checkbox_checked = $(':checked:not(#checkall)').length;

                //判断是否相等
                var checked = checkbox_len == checkbox_checked;

                $('#checkall').prop('checked', checked);

            });

            //全选checkbox点击事件
            $('#checkall').click(function () {
                var checked = $(this).prop('checked');
                //设置其他为选中状态
                $(':checkbox:not(#checkall)').prop('checked', checked);
                get_total();
            })


            //数量修改
            $('.num_show').blur(function () {
                //获取当前的数量
                var count = parseInt($(this).val());
                //验证数量是否合法
                if (isNaN(count)){
                    count = 1;
                } else if (count <= 1){
                    count = 1;
                } else  if (count >= 5){
                    count = 5;
                }

                //将有效值显示到文本框中
                $(this).val(count);
                //更新小计，总计
                get_total();
                //请求服务器，更改购物车中的数量

                var data = {
                    'sku_id': $(this).parents('.col06').siblings('.col01').children('input').val(),
                    'count': count,
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                }

                $.post('/cart/edit', data);


            });

            //点击加号添加一
            $('.add').click(function () {
                var count = parseInt($(this).next().val());
                count++;
                if (count <= 5){
                    //数量限制，超过5就不会向服务器发请求
                    $(this).next().val(count).blur();
                }
            });

            //点击建号减一
            $('.minus').click(function () {
                var count = parseInt($(this).prev().val());
                count--;
                if (count >=1){
                    //当最低数不合法时，停止请求服务器
                    $(this).prev().val(count).blur();
                }
            });

            //删除
            $('.col08>a').click(remove_click);

        })


        function get_total() {
            var total_price = 0, total_count = 0, total_select = 0;
            //遍历数组， i为元素索引， n为元素对象
            $('.cart_list_td').each(function (i,n) {
                //商品价格
                var price = parseFloat($(n).find('span').text());
                //商品数量
                var count = parseInt($(n).find('.num_show').val());
                //计算小计
                var total = price * count;
                //显示
                $(n).children('.col07').children('em').text(total.toFixed(2));
                //总数
                if (!isNaN(count)){
                    total_count += count;
                }
                //如果商品被选中，计算总价，总个数
                if ($(n).children('.col01').children('input').prop('checked')) {
                    //计算总价
                    total_price += total;
                    //计算总个数
                    total_select += count;
                }
            });
            //显示总计的值
            $('.total_count>em').text(total_count);
            $('.settlements em').text(total_price.toFixed(2));
            $('.settlements b').text(total_select)
        }

        function remove_click() {
            if (confirm('你真的要删除这件商品吗？？？')){
                var ul = $(this).parents('ul');
                $.post('/cart/delete',{
                    'sku_id' : $(this).parent().siblings('.col01').children('input').val(),
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },function (data) {
                    if (data.status == 1){
                        ul.remove();
                    }
                }) ;
            }
        }


    </script>

{% endblock head %}

{% block block2 %}

	<div class="total_count">全部商品<em></em>件</div>

	<ul class="cart_list_th clearfix">
		<li class="col01">商品名称</li>
		<li class="col02">商品单位</li>
		<li class="col03">商品价格</li>
		<li class="col04">数量</li>
		<li class="col05">小计</li>
		<li class="col06">操作</li>
	</ul>

    <form method="get" action="/order/">
    {% for sku in sku_list %}
        <ul class="cart_list_td clearfix">
            <li class="col01"><input type="checkbox" name="sku_id" value="{{ sku.id }}" checked="checked"></li>
            <li class="col02"><img src="{{ sku.default_image.url }}"></li>
            <li class="col03">{{ sku.name }}<br><em>{{ sku.stock }}</em></li>
            <li class="col04">{{ sku.unit }}</li>
            <li class="col05"><span>{{ sku.price }}</span>元</li>
            <li class="col06">
                <div class="num_add">
                    <a href="javascript:;" class="add fl">+</a>
                    <input type="text" class="num_show fl" value="{{ sku.cart_count }}">
                    <a href="javascript:;" class="minus fl">-</a>
                </div>
            </li>
            <li class="col07"><em></em>元</li>
            <li class="col08"><a href="javascript:;">删除</a></li>
        </ul>
    {% empty %}
        <ul><li>您尚未添加任何商品哦～～～</li></ul>
    {% endfor %}

	<ul class="settlements">
		<li class="col01"><input type="checkbox" id="checkall" checked="checked"></li>
		<li class="col02">全选</li>
		<li class="col03">合计(不含运费)：<span>¥</span><em></em><br>共计<b></b>件商品</li>
		<li class="col04"><input type="submit" value="去结算"></li>
	</ul>
    </form>
{% endblock block2 %}